<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>/* copy from https://github.com/sindresorhus/github-markdown-css/ */

html,body{background-color: #fdf6e3;}

.markdown-body {
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  line-height: 1.5;
  color: #586e75;
  font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;
  font-size: 16px;
  line-height: 1.5;
  word-wrap: break-word;
}

.markdown-body .octicon {
  display: inline-block;
  fill: currentColor;
  vertical-align: text-bottom;
}

.markdown-body figure{margin:0;padding:0; display:table;}
.markdown-body figure figcaption{font-size:92%; text-align:center; color:#859900;}

.markdown-body .anchor {
  float: left;
  line-height: 1;
  margin-left: -20px;
  padding-right: 4px;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  color: #6c71c4;
  vertical-align: middle;
  visibility: hidden;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  text-decoration: none;
}

.markdown-body details {
  display: block;
}

.markdown-body summary {
  display: list-item;
}

.markdown-body a {
  background-color: initial;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline-width: 0;
}

.markdown-body strong {
  font-weight: inherit;
  font-weight: bolder;
}
.markdown-body strong{
  color: #dc322f;
}
.markdown-body em{
  color: #cb4b16;
}

.markdown-body h1 {
  font-size: 2em;
  margin: .67em 0;
}

.markdown-body img {
  border-style: none;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace,monospace;
  font-size: 1em;
}

.markdown-body hr {
  box-sizing: initial;
  height: 0;
  overflow: visible;
}

.markdown-body input {
  font: inherit;
  margin: 0;
}

.markdown-body input {
  overflow: visible;
}

.markdown-body [type=checkbox] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body * {
  box-sizing: border-box;
}

.markdown-body input {
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
}

.markdown-body a {
  color: #2aa198;
  text-decoration: none;
}
.markdown-body mjx-container[jax="SVG"] > svg a{fill:#2aa198;stroke: #2aa198;}

.markdown-body a:hover {
  text-decoration: underline;
}

.markdown-body strong {
  font-weight: 600;
}

.markdown-body hr:after,
.markdown-body hr:before {
  display: table;
  content: "";
}

.markdown-body hr:after {
  clear: both;
}

.markdown-body table {
  border-spacing: 0;
  border-collapse: collapse;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body details summary {
  cursor: pointer;
}

.markdown-body kbd {
  display: inline-block;
  padding: 3px 5px;
  font: 12px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;
  line-height: 12px;
  color: #859900;
  vertical-align: middle;
  background-color: #f6efdc;
  border: 1px solid #e0d9c6;
  border-radius: 3px;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body h1 {
  font-size: 32px;
}

.markdown-body h1,
.markdown-body h2 {
  font-weight: 600;
}

.markdown-body h2 {
  font-size: 24px;
}

.markdown-body h3 {
  font-size: 20px;
}

.markdown-body h3,
.markdown-body h4 {
  font-weight: 600;
}

.markdown-body h4 {
  font-size: 16px;
}

.markdown-body h5 {
  font-size: 14px;
}

.markdown-body h5,
.markdown-body h6 {
  font-weight: 600;
}

.markdown-body h6 {
  font-size: 12px;
}

.markdown-body p {
  margin-top: 0;
  margin-bottom: 10px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ol,
.markdown-body ul {
  padding-left: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ol ol ol,
.markdown-body ol ul ol,
.markdown-body ul ol ol,
.markdown-body ul ul ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre {
  font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body input::-webkit-inner-spin-button,
.markdown-body input::-webkit-outer-spin-button {
  margin: 0;
  -webkit-appearance: none;
  appearance: none;
}

.markdown-body:after,
.markdown-body:before {
  display: table;
  content: "";
}

.markdown-body:after {
  clear: both;
}

.markdown-body>:first-child {
  margin-top: 0!important;
}

.markdown-body>:last-child {
  margin-bottom: 0!important;
}

.markdown-body a:not([href]) {
  color: inherit;
  text-decoration: none;
}

.markdown-body blockquote,
.markdown-body details,
.markdown-body dl,
.markdown-body ol,
.markdown-body p,
.markdown-body pre,
.markdown-body table,
.markdown-body ul {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: .25em;
  padding: 0;
  margin: 24px 0;
  background-color: #e0d9c6;
  border: 0;
}

.markdown-body blockquote {
  padding: 0 1em;
  color: #889ea5;
  border-left: .25em solid #d33682;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 24px;
  margin-bottom: 16px;
  font-weight: 600;
  line-height: 1.25;
}

.markdown-body h1 {
  font-size: 2em;
}

.markdown-body h1,
.markdown-body h2 {
  padding-bottom: .3em;
  border-bottom: 1px solid #e6dfcc;
  color: #6c71c4;
}

.markdown-body h2 {
  font-size: 1.5em;
  color: #6c71c4;
}

.markdown-body h3 {
  font-size: 1.25em;
  color: #6c71c4;
}

.markdown-body h4 {
  font-size: 1em;
  color: #268bd2;
}

.markdown-body h5 {
  font-size: .875em;
  color: #268bd2;
}

.markdown-body h6 {
  font-size: .85em;
  color: #268bd2;
}

.markdown-body ol,
.markdown-body ul {
  padding-left: 2em;
}

.markdown-body ol ol,
.markdown-body ol ul,
.markdown-body ul ol,
.markdown-body ul ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li {
  word-wrap: break-all;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body li+li {
  margin-top: .25em;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: 600;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
}

.markdown-body table th {
  font-weight: 600;
}

.markdown-body table td,
.markdown-body table th {
  padding: 6px 13px;
  border: 1px solid #b8b19e;
}

.markdown-body table tr {
  background-color: #fdf6e3;
  border-top: 1px solid #b8b19e;
}

.markdown-body table th {
  background-color: #e6dfcc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f7f0dd;
}

.markdown-body img {
  max-width: 100%;
  box-sizing: initial;
}

.markdown-body img[align=right] {
  padding-left: 20px;
}

.markdown-body img[align=left] {
  padding-right: 20px;
}

.markdown-body code {
  padding: .2em .4em;
  margin: 0;
  font-size: 85%;
  background-color: #f6efdc;
  color: #859900;
  border-radius: 3px;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
   font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f6efdc;
  border-radius: 3px;
}

.markdown-body pre code {
  display: inline;
  max-width: auto;
  padding: 0;
  margin: 0;
  overflow: visible;
  line-height: inherit;
  word-wrap: normal;
  background-color: initial;
  border: 0;
  color: #859900;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 .2em .25em -1.6em;
  vertical-align: middle;
}
.markdown-body section.footnotes{
    margin-top:48px;
    border-top:solid 1px #e0d9c6;
    padding-top:0px;
}

@media (prefers-color-scheme: dark) {
  .markdown-body mark{color: #111;}
}

/* PrismJS 1.23.0
https://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */


code[class*="language-"],
pre[class*="language-"] {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
}

@media print {
    code[class*="language-"],
    pre[class*="language-"] {
        text-shadow: none;
    }
}

/* Code blocks */
pre[class*="language-"] {
    padding: 1em;
    margin: .5em 0;
    overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
    background-color: #f6efdc;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
    padding: .1em;
    border-radius: .3em;
    white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
    color: #008327;
}

.token.punctuation {
    color: #2834ce;
}

.token.namespace {
    opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
    color: #2834ce;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
    color: #d32d26;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
    color: #$$codeBlockColor$$;
}

.token.atrule,
.token.attr-value,
.token.keyword {
    color: #bc319c;
}

.token.function,
.token.class-name {
    color: #967d41;
}

.token.regex,
.token.important,
.token.variable {
    color: #784830;
}

.token.important,
.token.bold {
    font-weight: bold;
}
.token.italic {
    font-style: italic;
}

.token.entity {
    cursor: help;
}


pre[class*="language-"].line-numbers {
  position: relative;
  padding-left: 3.8em;
  counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
  position: relative;
  white-space: inherit;
}

.line-numbers .line-numbers-rows {
  position: absolute;
  pointer-events: none;
  top: 0;
  font-size: 100%;
  left: -3.8em;
  width: 3em; /* works for line-numbers below 1000 lines */
  letter-spacing: -1px;
  border-right: 1px solid #beb7a4;

  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;

}

  .line-numbers-rows > span {
    display: block;
    counter-increment: linenumber;
  }

    .line-numbers-rows > span:before {
      content: counter(linenumber);
      color: #beb7a4;
      display: block;
      padding-right: 0.8em;
      text-align: right;
    }


</style> <style>.mweb-charts{background:#fff;}
body{ box-sizing: border-box;
    margin: 0 auto;
    padding: 28px}
@media print{
    pre, code, pre code {
     overflow: visible !important;
     white-space: pre-wrap !important;       /* css-3 */
     white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
     white-space: -pre-wrap !important;      /* Opera 4-6 */
     white-space: -o-pre-wrap !important;    /* Opera 7 */
     word-wrap: break-word !important;       /* Internet Explorer 5.5+ */
    }
    html,body{margin:0;padding:4px;}
}



div.code-toolbar {
  position: relative;
}

div.code-toolbar > .toolbar {
  position: absolute;
  z-index: 10;
  top: .3em;
  right: .2em;
  transition: opacity 0.3s ease-in-out;
  opacity: 0;
}

div.code-toolbar:hover > .toolbar {
  opacity: 1;
}

/* Separate line b/c rules are thrown out if selector is invalid.
   IE11 and old Edge versions don't support :focus-within. */
div.code-toolbar:focus-within > .toolbar {
  opacity: 1;
}

div.code-toolbar > .toolbar > .toolbar-item {
  display: inline-block;
}

div.code-toolbar > .toolbar > .toolbar-item > a {
  cursor: pointer;
}

div.code-toolbar > .toolbar > .toolbar-item > button {
  background: none;
  border: 0;
  color: inherit;
  font: inherit;
  line-height: normal;
  overflow: visible;
  padding: 0;
  -webkit-user-select: none; /* for button */
  -moz-user-select: none;
  -ms-user-select: none;
}

div.code-toolbar > .toolbar > .toolbar-item > a,
div.code-toolbar > .toolbar > .toolbar-item > button,
div.code-toolbar > .toolbar > .toolbar-item > span {
  color: inherit;
  font-size: .8em;
  padding: 4px .5em;
  background: #f5f2f0;
  background: rgba(224, 224, 224, 0.4);
  box-shadow: 0 2px 0 0 rgba(0,0,0,0.2);
  border-radius: .5em;
}

div.code-toolbar > .toolbar > .toolbar-item > a:hover,
div.code-toolbar > .toolbar > .toolbar-item > a:focus,
div.code-toolbar > .toolbar > .toolbar-item > button:hover,
div.code-toolbar > .toolbar > .toolbar-item > button:focus,
div.code-toolbar > .toolbar > .toolbar-item > span:hover,
div.code-toolbar > .toolbar > .toolbar-item > span:focus {
  color: inherit;
  text-decoration: none;
}
</style><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.css"><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script><style>div.code-toolbar > .toolbar > .toolbar-item > a, div.code-toolbar > .toolbar > .toolbar-item > button, div.code-toolbar > .toolbar > .toolbar-item > span {padding: 4px .5em; background: #f5f2f0; background: rgba(224, 224, 224, 0.4);}</style><script>window.MathJax = {     tex: { tags: 'ams', inlineMath: [ ['$','$'], ['\\(','\\)'] ] },     startup: {     pageReady() {       return MathJax.startup.defaultPageReady().then(function () {          window.mweb_mathjax_ready_val = 'yes';          if(window.mweb_mathjax_ready !== undefined){ mweb_mathjax_ready(); }       });     }   }};document.addEventListener('DOMContentLoaded', function(event) {    if (typeof Prism != 'undefined') {         Prism.highlightAll();     }});window.mweb_mathjax_ready_val = '';function theMWebMathJaxRenderIsReady(key){ return window.mweb_mathjax_ready_val; }</script><script>document.addEventListener('DOMContentLoaded', function(event) {window.mweb_mathjax_ready_val = 'yes';})</script></head><body><div id='markdown_content' class='markdown-body'><h1><a id="%E4%BD%BF%E7%94%A8async-io%E5%9C%A8-python%E4%B8%AD%E8%BF%9B%E8%A1%8C%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E7%9A%84%E4%BB%8B%E7%BB%8D" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用 Async IO 在 Python 中进行异步编程的介绍</h1>
<p>许多程序员都熟悉编写顺序（同步）代码，在异步世界中，事件的发生独立于主程序流程。这意味着动作在后台执行，无需等待上一个动作完成。</p>
<p>换句话说，代码行是并发执行的。</p>
<p>想象一下，你有一些独立的任务，每个任务都需要大量的运行时间才能完成。他们的输出不相互依赖。所以，您想一次启动它们。如果这些任务按特定顺序执行，程序将不得不等待每个任务完成后再开始下一个任务。等待时间会阻塞程序。</p>
<p>异步编程范例有助于并发执行这些任务，并确保您可以克服等待时间并更有效地使用资源。</p>
<h1><a id="%E5%9C%A8python%E4%B8%AD%E5%BC%95%E5%85%A5%E5%BC%82%E6%AD%A5" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>在 Python 中引入异步</h1>
<p>Python 中引入了两个主要组件：</p>
<ol>
<li><code>async io</code> 这是一个 Python 包，允许 API 运行和管理协程。</li>
<li><code>async/await</code> 用来定义协程。</li>
</ol>
<p>例如要进行 HTTP 调用，请考虑使用 <code>aiohttp</code> ，这是一个 Python 包，允许异步进行 HTTP 调用。在异步代码中，常用的 <code>requests</code> 库可能效果不是很好。</p>
<p>同样，如果您正在使用 Mongo 数据库，而不是依赖同步驱动程序（如 <code>mongo-python</code> ），您必须使用异步驱动程序（如 <code>moto</code> 异步访问 MongoDB）。</p>
<p>在异步世界中，一切都在事件循环中运行。这允许您一次运行多个协程。我们将在本教程中了解协程是什么。</p>
<p>里面的一切 <code>async def</code> 都是异步代码，其他一切都是同步的。</p>
<p>编写异步代码不像编写同步代码那么容易。Python 异步模型基于事件、回调、传输、协议和期货等概念。</p>
<h1><a id="%E5%BC%82%E6%AD%A5%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>异步如何工作</h1>
<p><code>asyncio</code> 库提供了两个关键字， <code>async</code> 和 <code>await</code> .</p>
<p>让我们看一下这个 async hello-world 示例：</p>
<pre class="line-numbers"><code class="language-python">import asyncio


async def hello():
    print(&quot;Hello World!&quot;)
    await asyncio.sleep(1)
    print(&quot;Hello again!&quot;)


asyncio.run(hello())


# Hello World!
# Hello again!
</code></pre>
<p>乍一看你可能认为这是一个同步代码，因为第二次打印等待 1 秒打印<code>Hello again!</code> 在<code>Hello World!</code>之后。但是这段代码实际上是异步的。</p>
<h1><a id="%E5%8D%8F%E7%A8%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>协程</h1>
<p>任何定义为 <code>async def</code> 的函数都是像上面那样的协程。需要注意的是，调用 <code>hello()</code> 函数需要在 <code>asyncio.run()</code> 中执行，</p>
<p>为了运行协程，<code>asyncio</code> 提供了三种主要机制：</p>
<p><code>asyncio.run()</code> 函数，它是启动事件循环并运行异步的主要入口点。</p>
<p>使用 <code>await</code> 协程的结果并将控制权传递给事件循环。</p>
<pre class="line-numbers"><code class="language-python">import asyncio
import time


async def say_something(delay, words):
    print(f&quot;Before {words}&quot;)
    await asyncio.sleep(delay)
    print(f&quot;After {words}&quot;)
    
async def main():
    print(f&quot;Started: {time.strftime('%X')}&quot;) 
    await say_something(1, &quot;Task 1&quot;)
    await say_something(2, &quot;Task 2&quot;)
    print(f&quot;Finished: {time.strftime( '%X' )}&quot;)


asyncio.run(main())


# Started:15:59:52
# Before Task 1
# After Task 1
# Before Task 2
# After Task 2
# Finished:15:59:55
</code></pre>
<p>前面的代码片段仍然等待 <code>say_something()</code> 协程完成，因此它在 1 秒内执行第一个任务，然后在等待 2 秒后执行第二个任务。</p>
<p>要让协程并发运行，我们应该创建任务，这是第三种机制。</p>
<p><code>asyncio.create_task()</code> 用于安排协程执行的函数。</p>
<pre class="line-numbers"><code class="language-python">import asyncio
import time


async def say_something(delay, words):
    print(f&quot;Before {words}&quot;)
    await asyncio.sleep(delay)
    print(f&quot;After {words}&quot;)
    
async def main():
    print(f&quot;Started: {time.strftime('%X')}&quot;)
    task1 = asyncio.create_task(say_something(1,&quot;Task 1&quot;)) 
    task2 = asyncio.create_task(say_something(2, &quot;Task 2&quot;)) 
    await task1
    await task2
    print(f&quot;Finished: {time.strftime('%X')}&quot;)


asyncio.run(main())


# Started:16:07:35
# Before Task 1
# Before Task 2
# After Task 1
# After Task 2
# Finished:16:07:37
</code></pre>
<p>上面的代码现在并发运行，<code>say_something()</code> 协程不再等待 <code>say_something()</code> 协程完成。而是同时运行具有不同参数的同一个协程。</p>
<p>发生的情况如下：</p>
<p><code>say_something()</code> 协程从参数的第一个任务（1 秒和一个字符串<code>Task 1</code>）开始。这个任务叫做 <code>task1</code>。</p>
<p>然后它会暂停协程的执行并等待 1 秒让 <code>say_something()</code> 协程在遇到 <code>await</code> 关键字时完成。它将控制权返回给事件循环。</p>
<p>同样对于第二个任务，它会暂停协程的执行并等待 2 秒让 <code>say_something()</code> 协程完成，因为它遇到 <code>await</code> 关键字。</p>
<p><code>task1</code> 控制返回到事件循环后，事件循环继续执行第二个任务 <code>task2</code> 因为 <code>asyncio.sleep()</code> 还没有完成。</p>
<p><code>asyncio.create_task()</code> 包装 <code>say_something()</code> 函数并使其作为异步任务同时运行协程。 如您所见，上面的代码片段显示它的运行速度比以前快了 1 秒。</p>
<p>当 <code>asyncio.create_task()</code> 被调用时，协程会自动安排在事件循环中运行。</p>
<p>任务可以帮助您并发运行多个协程，但这并不是实现并发的唯一方法。</p>
<h1><a id="%E4%BD%BF%E7%94%A8asyncio-gather%E8%BF%90%E8%A1%8C%E5%B9%B6%E5%8F%91%E4%BB%BB%E5%8A%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用 asyncio.gather() 运行并发任务</h1>
<p>另一种同时运行多个协程的方法是使用 <code>asyncio.gather()</code> 函数。此函数将协程作为参数并并发运行它们。</p>
<pre class="line-numbers"><code class="language-python">import asyncio
import time


async def greetings():
    print(&quot;Welcome&quot;)
    await asyncio.sleep(1)
    print(&quot;Goodbye&quot;)


async def main():
    start = time.time()
    await asyncio.gather(greetings(), greetings())
    elapsed = time.time() - start
    print(f&quot;{__name__} executed in {elapsed:0.2f} seconds.&quot;)


asyncio.run(main())


# Welcome
# Welcome
# Goodbye
# Goodbye
# __main__ executed in 1.00 seconds.

</code></pre>
<p>在前面的代码中，<code>greetings()</code> 协程被并发执行了两次。</p>
<h1><a id="%E7%AD%89%E5%BE%85%E5%AF%B9%E8%B1%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>等待对象</h1>
<p>如果一个对象可以与 <code>await</code> 关键字一起使用，则该对象称为可等待对象。可等待对象主要有 3 种类型：<code>coroutines</code>、<code>tasks</code>和<code>futures</code>。</p>
<h2><a id="coroutines" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>coroutines</h2>
<pre class="line-numbers"><code class="language-python">import asyncio


async def mult(first, second):
    print(&quot;Calculating multiplication...&quot;)
    await asyncio.sleep(1)
    mul = first * second
    print(f&quot;{first} multiplied by {second} is {mul}&quot;)
    return mul


async def add(first, second):
    print(&quot;Calculating sum...&quot;)
    await asyncio.sleep(1)
    sum = first + second
    print(f&quot;Sum of {first} and {second} is {sum}&quot;)
    return sum


async def main(first, second):
    await mult(first, second)
    await add(first, second)


asyncio.run(main(10, 20))


# Calculating multiplication...
# 10 multiplied by 20 is 200
# Calculating sum...
# Sum of 10 and 20 is 30

</code></pre>
<p>在前面的示例中， 协同程序 <code>main()</code> 等待 <code>mult()</code> 和 <code>add()</code> 结束。</p>
<p>假设您在 <code>mult</code> 协程之前省略了 <code>await</code> 关键字。然后您将收到以下错误： <code>RuntimeWarning: coroutine 'mult' was never awaited.</code>。</p>
<h2><a id="tasks" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>tasks</h2>
<p>要安排协程在事件循环中运行，我们使用 <code>asyncio.create_task()</code> 函数。</p>
<pre class="line-numbers"><code class="language-python">import asyncio


async def mult(first, second):
    print(&quot;Calculating multiplication...&quot;)
    await asyncio.sleep(1)
    mul = first * second
    print(f&quot;{first} multiplied by {second} is {mul}&quot;)
    return mul


async def add(first, second):
    print(&quot;Calculating sum...&quot;)
    await asyncio.sleep(1)
    sum = first + second
    print(f&quot;Sum of {first} and {second} is {sum}&quot;)
    return sum


async def main(first, second):
    mult_task = asyncio.create_task(mult(first, second))
    add_task = asyncio.create_task(add(first, second))
    await mult_task
    await add_task


asyncio.run(main(10, 20))


# Calculating multiplication...
# Calculating sum...
# 10 multiplied by 20 is 200
# Sum of 10 and 20 is 30
</code></pre>
<h2><a id="futures" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>futures</h2>
<p>Future 是表示异步计算结果的低级可等待对象。它是通过调用 <code>asyncio.Future()</code> 函数创建的。</p>
<pre class="line-numbers"><code class="language-python">from asyncio import Future


future = Future()
print(future.done())
print(future.cancelled())
future.cancel()
print(future.done())
print(future.cancelled())


# False
# False
# True
# True

</code></pre>
<h1><a id="%E8%B6%85%E6%97%B6" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>超时</h1>
<p>用于 <code>asyncio.wait_for(aw, timeout, *)</code> 设置等待对象完成的超时。请注意， <code>aw</code> 这里是可等待的对象。如果要在可等待对象完成时间过长时引发异常，这将很有用。作为异常 <code>asyncio.TimeoutError</code>。</p>
<pre class="line-numbers"><code class="language-python">import asyncio


async def slow_operation():
    await asyncio.sleep(400)
    print(&quot;Completed.&quot;)


async def main():
    try:
        await asyncio.wait_for(slow_operation(), timeout=1.0)
    except asyncio.TimeoutError:
        print(&quot;Timed out!&quot;)


asyncio.run(main())


# Timed out!
</code></pre>
<p>尽管协程需要 400 秒才能完成，但 <code>slow_operation()</code> 中的超时 Future 设置为 1 秒。</p>
</div></body></html>